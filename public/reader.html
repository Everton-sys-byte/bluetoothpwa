<!DOCTYPE html>
<html lang="pt-br">
<head>
    <title>Leitor de iBeacon via Web Bluetooth</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; padding: 1em; }
        #scanButton { font-size: 1.1em; padding: 10px 15px; cursor: pointer; }
        #results div { background-color: #f0f0f0; border: 1px solid #ddd; padding: 15px; margin-top: 10px; border-radius: 8px; }
        hr { border: 0; border-top: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>Leitor de iBeacon com JavaScript</h1>
    <p>Clique no botão para procurar por iBeacons. O navegador solicitará permissão e pedirá que você selecione um dispositivo Bluetooth na lista para iniciar o monitoramento.</p>
    <button id="scanButton">Procurar iBeacons</button>
    <div id="results"></div>

    <script>
        const scanButton = document.getElementById('scanButton');
        const resultsDiv = document.getElementById('results');
        const APPLE_COMPANY_ID = 0x004C; // ID da Apple para iBeacons
        const IBEACON_TYPE = 0x0215;     // Prefixo de dados que identifica um iBeacon

        scanButton.addEventListener('click', async () => {
            try {
                resultsDiv.innerHTML = 'Procurando...';
                console.log('Solicitando dispositivo Bluetooth...');

                // ALTERAÇÃO 1: Filtrar por dispositivos que anunciam dados da Apple.
                // Isso é mais eficiente do que aceitar todos os dispositivos.
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{
                        manufacturerData: { [APPLE_COMPANY_ID]: {} }
                    }],
                    optionalServices: [] // Necessário para inspecionar advertisements
                });

                console.log(`Dispositivo "${device.name || device.id}" selecionado. Observando advertisements...`);

                const abortController = new AbortController();

                device.addEventListener('advertisementreceived', handleAdvertisement);

                // Inicia o monitoramento dos pacotes de anúncio
                await device.watchAdvertisements({ signal: abortController.signal });

                console.log('Monitoramento iniciado. Parando em 30 segundos.');
                // Para o scan após 30 segundos para economizar bateria
                setTimeout(() => {
                    abortController.abort();
                    console.log('Scan parado.');
                    if (resultsDiv.innerHTML === 'Procurando...') {
                        resultsDiv.innerHTML = 'Busca finalizada. Nenhum iBeacon foi encontrado.'
                    } else {
                        resultsDiv.innerHTML += '<p>Busca finalizada.</p>';
                    }
                }, 30000);

            } catch (error) {
                console.error('Ocorreu um erro:', error);
                resultsDiv.innerHTML = `<strong>Erro:</strong> ${error.message}`;
            }
        });

        function handleAdvertisement(event) {
            const companyData = event.manufacturerData.get(APPLE_COMPANY_ID);

            // ALTERAÇÃO 2: A lógica de validação foi descomentada e ativada.
            // Esta é a verificação mais importante.
            // 1. Garante que o pacote tenha os dados do fabricante da Apple.
            if (!companyData) {
                return;
            }

            // 2. Garante que os dados tenham o tamanho correto e o prefixo do iBeacon (0x0215).
            // O payload de um iBeacon tem 25 bytes no total (2 de prefixo + 23 de dados).
            if (companyData.byteLength < 23 || companyData.getUint16(0, false) !== IBEACON_TYPE) {
                return;
            }

            console.log('Pacote iBeacon válido recebido!');

            // Decodifica os dados do iBeacon
            const uuid = parseUUID(companyData, 2); // UUID inicia no byte de offset 2
            const major = companyData.getUint16(18, false); // Major inicia no byte 18
            const minor = companyData.getUint16(20, false); // Minor inicia no byte 20
            const txPower = companyData.getInt8(22);      // TX Power está no byte 22
            const rssi = event.rssi;

            const beaconId = `beacon-${uuid}-${major}-${minor}`;

            let beaconDiv = document.getElementById(beaconId);
            if (!beaconDiv) {
                // Limpa a mensagem "Procurando..." no primeiro resultado
                if (resultsDiv.innerHTML === 'Procurando...') resultsDiv.innerHTML = '';
                beaconDiv = document.createElement('div');
                beaconDiv.id = beaconId;
                resultsDiv.appendChild(beaconDiv);
            }

            beaconDiv.innerHTML = `
                <strong>iBeacon Encontrado!</strong><br>
                <small>Dispositivo: ${event.device.name || 'Desconhecido'}</small><br>
                <strong>RSSI:</strong> ${rssi} dBm<br>
                <strong>UUID:</strong> ${uuid}<br>
                <strong>Major:</strong> ${major}<br>
                <strong>Minor:</strong> ${minor}<br>
                <strong>TX Power (a 1m):</strong> ${txPower} dBm<br>
            `;
        }

        function parseUUID(dataView, offset) {
            let uuid = '';
            for (let i = 0; i < 16; i++) {
                // Converte cada byte para uma string hexadecimal de 2 dígitos
                const hex = dataView.getUint8(offset + i).toString(16).padStart(2, '0');
                uuid += hex;
                // Adiciona os hifens na formatação padrão do UUID
                if (i === 3 || i === 5 || i === 7 || i === 9) {
                    uuid += '-';
                }
            }
            return uuid.toUpperCase();
        }
    </script>
</body>
</html>
