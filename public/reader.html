<!DOCTYPE html>
<html>
<head>
    <title>Leitor de iBeacon via Web Bluetooth (com Try/Catch)</title>
</head>
<body>
    <h1>Leitor de iBeacon com JavaScript</h1>
    <button id="scanButton">Procurar Dispositivos</button>
    <div id="results"></div>

    <script>
        const scanButton = document.getElementById('scanButton');
        const resultsDiv = document.getElementById('results');
        const APPLE_COMPANY_ID = 0x004C;

        scanButton.addEventListener('click', async () => {
            try {
                resultsDiv.innerHTML = 'Procurando...';
                // ATENÇÃO: acceptAllDevices mostra TODOS os dispositivos,
                // e o script só vai ouvir o que for selecionado.
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: []
                });

                resultsDiv.innerHTML += `Dispositivo ${device.name || device.id} selecionado. Observando advertisements...`;
                const abortController = new AbortController();
                device.addEventListener('advertisementreceived', handleAdvertisement);
                await device.watchAdvertisements({ signal: abortController.signal });

                setTimeout(() => {
                    abortController.abort();
                    resultsDiv.innerHTML += 'Scan parado.';
                    resultsDiv.innerHTML += '<p>Busca finalizada.</p>';
                }, 30000);

            } catch (error) {
                resultsDiv.innerHTML += 'Erro principal:', error;
                resultsDiv.innerHTML = `Erro: ${error.message}`;
            }
        });

        function handleAdvertisement(event) {
            // O bloco try...catch é colocado aqui para tratar cada pacote individualmente.
            try {
                const companyData = event.manufacturerData.get(APPLE_COMPANY_ID);

                // Esta verificação é crucial e está fora do try/catch
                // para evitar processamento desnecessário.
                if (!companyData || companyData.byteLength < 23 || companyData.getUint16(0, false) !== 0x0215) {
                    // Se não for um pacote iBeacon válido, simplesmente o ignora.
                    return;
                }

                // Se passou na verificação, tenta decodificar.
                const uuid = parseUUID(companyData, 2);
                const major = companyData.getUint16(18, false);
                const minor = companyData.getUint16(20, false);
                const txPower = companyData.getInt8(22);
                const rssi = event.rssi;

                const beaconId = `${uuid}-${major}-${minor}`;
                
                let beaconDiv = document.getElementById(beaconId);
                if (!beaconDiv) {
                    if (resultsDiv.innerHTML === 'Procurando...') resultsDiv.innerHTML = '';
                    beaconDiv = document.createElement('div');
                    beaconDiv.id = beaconId;
                    resultsDiv.appendChild(beaconDiv);
                }

                beaconDiv.innerHTML = `
                    <strong>iBeacon Encontrado!</strong><br>
                    <strong>RSSI:</strong> ${rssi} dBm<br>
                    <strong>UUID:</strong> ${uuid}<br>
                    <strong>Major:</strong> ${major}<br>
                    <strong>Minor:</strong> ${minor}<br>
                    <strong>TX Power:</strong> ${txPower} dBm<br>
                    <hr>
                `;
            } catch (error) {
                // Se ocorrer um erro ao decodificar, ele será capturado aqui.
                // Isso evita que o programa pare.
                resultsDiv.innerHTML += 'Ignorando pacote de anúncio não-iBeacon ou malformado.';
            }
        }

        function parseUUID(dataView, offset) {
            let uuid = '';
            for (let i = 0; i < 16; i++) {
                const hex = dataView.getUint8(offset + i).toString(16).padStart(2, '0');
                uuid += hex;
                if (i === 3 || i === 5 || i === 7 || i === 9) {
                    uuid += '-';
                }
            }
            return uuid;
        }
    </script>
</body>
</html>