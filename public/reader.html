<!DOCTYPE html>
<html>
<head>
    <title>Leitor de iBeacon via Web Bluetooth</title>
</head>
<body>
    <h1>Leitor de iBeacon com JavaScript</h1>
    <button id="scanButton">Procurar iBeacons</button>
    <div id="results"></div>

    <script>
        const scanButton = document.getElementById('scanButton');
        const resultsDiv = document.getElementById('results');
        const APPLE_COMPANY_ID = 0x004C; // ID da Apple para iBeacons

        scanButton.addEventListener('click', async () => {
            try {
                console.log('Solicitando dispositivo Bluetooth...');
                resultsDiv.innerHTML = 'Procurando...';

                // Solicita permissão ao usuário para escanear
//                const device = await navigator.bluetooth.requestDevice({
//                    acceptAllDevices: true,
//                    optionalServices: [] // Necessário para ver advertisements
//                });
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{name: 'MR00000003'}],
                    optionalServices: [] // Necessário para inspecionar advertisements
                });



                console.log(`Dispositivo ${device.name || device.id} selecionado. Observando advertisements...`);

                // AbortController para parar o scan depois de um tempo
                const abortController = new AbortController();

                // Adiciona o listener para "escutar" os pacotes
                device.addEventListener('advertisementreceived', (event) => {
                    handleAdvertisement(event);
                });

                // Inicia o scan
                await device.watchAdvertisements({ signal: abortController.signal });

                // Para o scan após 30 segundos para economizar bateria
                setTimeout(() => {
                    abortController.abort();
                    console.log('Scan parado.');
                    resultsDiv.innerHTML += '<p>Busca finalizada.</p>';
                }, 30000);

            } catch (error) {
                console.error('Ocorreu um erro:', error);
                resultsDiv.innerHTML = `Erro: ${error.message}`;
            }
        });

        function handleAdvertisement(event) {
            const companyData = event.manufacturerData.get(APPLE_COMPANY_ID);

            // Verifica se é um pacote da Apple
//            if (!companyData) {
//                return;
//            }

            // `companyData` é um DataView. Verificamos se tem o tamanho esperado
            // e o tipo de iBeacon (0x0215)
//            if (companyData.byteLength < 23 || companyData.getUint16(0, false) !== 0x0215) {
//                return;
//            }

            // Decodifica os dados do iBeacon
            const uuid = parseUUID(companyData, 2);
            const major = companyData.getUint16(18, false);
            const minor = companyData.getUint16(20, false);
            const txPower = companyData.getInt8(22);
            const rssi = event.rssi;

            const beaconId = `${uuid}-${major}-${minor}`;
            
            // Exibe os resultados na tela
            let beaconDiv = document.getElementById(beaconId);
            if (!beaconDiv) {
                beaconDiv = document.createElement('div');
                beaconDiv.id = beaconId;
                resultsDiv.appendChild(beaconDiv);
            }

            beaconDiv.innerHTML = `
                <strong>iBeacon Encontrado!</strong><br>
                <strong>RSSI:</strong> ${rssi} dBm<br>
                <strong>UUID:</strong> ${uuid}<br>
                <strong>Major:</strong> ${major}<br>
                <strong>Minor:</strong> ${minor}<br>
                <strong>TX Power:</strong> ${txPower} dBm<br>
                <hr>
            `;
        }

        function parseUUID(dataView, offset) {
            let uuid = '';
            for (let i = 0; i < 16; i++) {
                const hex = dataView.getUint8(offset + i).toString(16).padStart(2, '0');
                uuid += hex;
                if (i === 3 || i === 5 || i === 7 || i === 9) {
                    uuid += '-';
                }
            }
            return uuid;
        }
    </script>
</body>
</html>